---
title: "Analysis of Age and Player Performance in CS: GO"
author: "Michael Allen"
date: "4/28/2020"
output: html_document
---

```{r setup, include=FALSE}
library(data.table)
library(ggplot2)
library(gridExtra)
library(xtable)
library(lubridate)
library(knitr)

opts_chunk$set(echo = TRUE)
playerData <- fread("../playerData.csv")

playerData[ , `:=` (kpr = kills / (playerTeam_score + oppoTeam_score),
                    dpr = deaths / (playerTeam_score + oppoTeam_score),
                    KD = kills / deaths,
                    totalRounds = (playerTeam_score + oppoTeam_score))]
playerData$date <- as_date(playerData$date)
playerData[ , careerLength := date - min(date), by = playerName]
playerData$careerLength <- as.integer(playerData$careerLength)

playerData <- playerData[!is.infinite(KD), ]
playerData <- playerData[!is.na(playerAge), ]

theme_set(theme_bw())
```

## Introduction

It is not uncommon to hear talk of a recently. Ample research has identified age effects in traditional sports. Even without more physically demands sports, however, there is extensive hetergeneity in the longevity of atheletic peformace. But esports are subject to an altogether different set of physical constraints.

## Data

Data for this analysis was collected from [HLTV.org](https://www.HLTV.org). Following in the footsteps of the now-defunct Gotfrag, HLTV has evolved into an invaluable resource for the CS: GO community. They collected match data. For good reason, the site is highly protective of this data. The data used in this analysis was collected for purley educational, non-commercial purposes.


### Player Sample
The players included in this analysis are limited to those who have played at least 1 map in a Major. This yields a sample of `r nrow(playerData)` observations (player-maps) across `r length(unique(playerData$playerName))` CS: GO players[^1]. The sample is likely biased towards longevitiy as all of the best players to play the game have played in a Major, while many on the cusp of becoming professional. However, given the Major's partially open qualification system, there are many players in the sample who have not achieved such an elite status. While this strategy successfuly restricts the sample to full-time, professional CS: GO players, it nevertheless leaves out a signifant chunk of the "second-tier" population of CS: GO players that play the game full time but never qualified for a Major. A future analysis may sample on participation in what HLTV codes as "Big events." This would likely capture the second-tier as most of the players in the group will have played in a handful of such events. "LAN" and "Online" categories would likely cast too wide of a net, brining in many amatuer players whose "career" trajectories are likely to be systematically different from professional players'.

[^1]: Observations with fewer than 16 reported rounds are dropped, as are maps in which players recorded 0 deaths (this removes two maps in which jks went 17-0 and 20-0 and one map in which f0rest went 16-0).

### Measuring Performance
I use kills per round as a simple measure of player performance. This gets at the "twitch" ability that is most likely to decline with age. I do not know what it means. No one outside of HLTV does, in fact. The formula is secret.

Now players develop other skills as they play the game that are likely to offset any decline in fragging ability.

#### Kills per round

#### HLTV Rating

The HLTV Rating is a hugely popular metric of player per-map performace. It is frequently cited by analysts and is featured prom

This is due in part to its apparent simplicty. A rating of 1.00 is what an "average" player would. Anything above 1.00 is above averange and anything below is below average. Simple. But what does it mean to be "average" in this case? No one outside of HLTV knows. The biggest problem with this rating is that HLTV refuses to reveal exactly how it is calculated. No one outside of HLTV therefore has much of an idea as to what exactly this rating measures and what how the "averages" that serve as the statistics anchor are calculated.

In response to criticism that its Rating 1.0 was no more informative than "simpler" stats like kill-death ratio, [HLTV developed Rating 2.0](https://www.hltv.org/news/20695/introducing-rating-20). While the formula used to calculate the new Rating 2.0 is secret, an [analysis by Chris Sardegna found](https://chrissardegna.com/blog/problems-with-csgo-rating-systems/) that Rating 2.0 suffers from the same problem. While Sardegna focused on the correlation between KD ratio and HLTV Ratings 1.0 and 2.0, KPR is an even better predictor of HLTV's Rating. Rating 2.0 and kills per round have a correlation coefficient (a simple measure of how change in one varialbe is correlated with change in another variable) of `r round(cor(playerData$kpr[playerData$HLTVrating2 == T], playerData$HLTVrating[playerData$HLTVrating2 == T]), 2)`. The correlation coefficient betwen KPR and HLTV Rating 1.0 is 
`r round(cor(playerData$kpr[playerData$HLTVrating2 == F], playerData$HLTVrating[playerData$HLTVrating2 == F]), 2)`. The figures below illustrate what might be driving the divergence between KPR and KD ration using the career statistics for the long-time Swedish player, Christopher "GeT_RiGhT" Alesund.

```{r graph, fig.align = "center", out.width="50%", echo=FALSE, fig.cap="Note: Blue line plots a local polynomial regression with a bandwidth of 0.75. Shaded region is 95% confidence interval."}
plotKPR <- ggplot(playerData[playerData$playerName == "GeT_RiGhT", ], 
                  aes(x = kpr, y = HLTVrating)) +
  geom_point(alpha = 0.4) +
  ylab("HLTV Rating") +
  xlab("Kills Per Round") +
  geom_smooth(method = "loess")

plotKD <- ggplot(playerData[playerData$playerName == "GeT_RiGhT", ],
                 aes(x = (kills / deaths), y = HLTVrating)) +
  geom_point(alpha = 0.4) +
  ylab("HLTV Rating") +
  xlab("Kill-Death Ratio") +
  geom_smooth(method = "loess")

grid.arrange(plotKPR, plotKD, ncol = 2, top = "GeT_RiGhT Career Performance")
```

Likely due to the down weighting of outliers, the correlation between KD and HLTV Rating seems to breakdown for extremely high KD values. The following figure plots **actual** HLTV Ratings against an **estimate** based on a linear model regressing HLTV's Rating on kills per round and deaths per round. As seen below, this simple model is highly predictive of the HLTV Rating, with an adjusted R^2^ of 0.93.

```{r linear model plot, fig.align = "center", out.width = "50%", echo = FALSE}
model1 <- lm(HLTVrating ~ kpr + dpr, data = playerData)
plotModel1 <- data.frame(observed = playerData$HLTVrating, 
                         predicted = model1$fitted.values,
                         stringsAsFactors = FALSE)
ggplot(plotModel1, aes(x = predicted, y = observed)) +
  geom_point(alpha = 0.4, size = .5) +
  xlab("Estimated HLTV Rating") +
  ylab("Observed HLTV Rating")
```

How does HLTV caluclate the "average" statistics that anchor its rating at 1.00? How are different aspects of the statistic weighted? I assume that the Rating captures something outside of KPR. We should expect the Rating therefore to perhaps be more stable than KPR as a player ages given that the player may shift towards other in-game activities picked up by HLTV that go unmeasured by KPR. These include assists[^2] or what HLTV calls "impact rating," which is a composite of events like opening kills and 1vX "wins."[^3]

[^2]: When a player contributes a certain amount of damage against an opponent, but another player is credited with the kill. It is unclear if HLTV includes flash assists.

[^3]: HLTV only reports that they include "1vX wins." Obviously, 1vX *loses* are relevant to evaluating a player's cluch performance as well, but HLTV does not specify if loses are included in its "Impact Rating."

### Descriptives
Some summary statistics:
```{r summary stats table, fig.align = "center", echo = FALSE}
sumStats <- data.table(variable = c('playerAge', 'careerLength', 'HLTVrating', 'kpr'))

sumStats <- as.data.frame(
  t(rbind(playerData[ , lapply(.SD, mean), .SDcols = sumStats$variable],
          playerData[ , lapply(.SD, sd), .SDcols = sumStats$variable],
          playerData[ , lapply(.SD, quantile), .SDcols = sumStats$variable])))
colnames(sumStats) <- c("Mean", "Std. Dev.", "0%", "25%", "50%", "75%", "100%")
rownames(sumStats) <- c("Player Age (days)", "Career Length (days)", "HLTV Rating", "Kills per round")
kable(round(sumStats, 2))
```